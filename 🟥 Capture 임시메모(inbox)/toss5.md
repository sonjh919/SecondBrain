## 실시간 리스크 분석 시스템을 설계해보자 ! (20 점 ) 
튼튼 PC 는 소비자의 결제 건을 카드사로부터 정산받은 뒤 , 해당 금액을 가맹점에 다시 정산해주는 서비스를 운영하고 있어요 . 
하지만 가맹점 정산이 완료된 이후에 소비자가 결제를 취소하게 되면 , 가맹점으로부터 회수해야 하는 미수 정 산액이 발생하고 , 이는 회사의 손실로 이어질 수 있어요 .
특히 특정 시점에 상품 미배송 , 부도 등으로 인한 거래 취소가 급종한 경우 , 리스크를 조기에 감지하지 못하면 큰손해가 발생할 수 있어요 . 
이문제를 해결하기 위해 , 튼튼 PC 는 가맹점의 이상 거래 패턴을 실시간으로 감지하고 위험 신호를 빠르게 탐 지할 수 있는 리스크 분석 시스템을 새롭게 구축하려고 해요 .

### 참고 정보
+ 시스템 환경 및 데이터 특성 하루 평균 거래량은 약 300 만 건이에요 . 
+ 순간적인 처리 속도는 TPS 5,000 이상까지 올라갈 수 있어요 . 
+ 전체 활성 가맹점 수는 약 10 만 개이며 , 이 중 상위 1% 의 가맹점이 전체 거래의 50% 이상을 차지하고 있 어요 . 

### 문제
이처럼 거래량이 많고 , 실시간으로 데이터가 많이 들어오는 상황에서 다음 요구사항을 지키며 최대한 빠르게 일람을 받으려면 어떤 방식으로 실시간 리스크 분석 시스템을 설계해야 할까요 ?

### 요구사항
+ 거래 서버의 RDB 에 저장된 데이터를 기반으로 분석해야 해요.
+ 거래시간 기준 1 분 단위 집계를 기준으로 리스크를 판단해야 해요 . ( 예 : 17:01:00 ~ 17:01:59 동안의 거 래정보 ) 
+ 알림 발생 조건은 다음 두 가지예요 . 
	1. 최근 7 일간의 평균 취소율 ( 취소 건수 / 승인 건수 ) 과 비교해 , 1 시간 동안의 취소율이 2 배 이상 증가했을 때
	2. 최근 일 거래액이 10 억 원 이상인 가맹점의 당일 거래액이 최근 평균 대비 50% 이상 급감했을 때
+ 실시간 알림 외에 , 가맹점 거래 관련 추이 확인을 위한 화면도 필요해요
---

### 실시간 스트림 처리 엔진

토스의 관련 시스템?
https://toss.im/tossfeed/article/rms
https://docs.tosspayments.com/resources/glossary/fds

토스 데이터파이프라인 운영법
https://toss.tech/article/toss-securities-visualize-lineage
https://toss.tech/article/MSA-observability

실시간 스트림 처리 엔진?
https://toss.tech/article/iceberg-cdc-1

---

g선생님 답변

실시간 리스크 분석 시스템을 최대한 빠르고 효율적으로 설계하려면, 스트림 처리와 집계 시스템을 결합하여 분산 환경에서도 안정적인 실시간 탐지와 알림, 그리고 심층 데이터 조회 기능을 동시에 제공하는 구조가 적합합니다.

## 아키텍처 설계 개요

실시간 거래 데이터의 처리량(TPS 5,000+)과 수백만 건의 집계, 그리고 RDB 기반 분석 요구를 보면 ‘실시간 스트림 처리 엔진’(예: Apache Kafka + Flink/Spark Streaming) 및 ‘초고속 캐싱/집계 시스템’을 조합하는 것이 핵심 전략입니다.

|구성 요소|역할 및 설명|
|---|---|
|거래 서버 RDB|거래 원천 데이터 저장 및 정합성 보장|
|CDC/로그 기반 ETL|RDB의 거래 데이터 변경 이벤트를 실시간 스트림에 반영|
|스트림 처리 엔진|Kafka Streams/Flink/Spark Streaming으로, 거래 이벤트를 1분 단위로 집계 및 실시간 분석|
|실시간 캐시/NoSQL|Redis, ScyllaDB 등으로 최근 집계/가맹점별 상태값 캐싱|
|모니터링/알림 서비스|취소율·금액 이상 패턴 감지 시 알림 트리거링 및 알림 발송|
|BI·대시보드 화면|시각화 플랫폼(Grafana/Metabase) 연동, 실시간 거래 추이 및 상세 분석 제공|

## 데이터 흐름 및 집계 과정

- 거래 서버 RDB에서 CDC(Change Data Capture) 또는 트랜잭션 로그 활용하여 Kafka 등 메시지 큐로 거래 이벤트를 스트림 형태로 전달.
    
- Flink/Spark Streaming 같은 분산 처리 엔진에서 1분 단위 윈도우별 다양한 집계(취소율, 거래액 등) 를 계산.
    
- 최근 7일간, 최근 1시간, 당일 집계값 등은 Redis 등 초고속 키-밸류 캐시에 TTL 붙여서 저장하며, 가맹점 단위로 알림 조건 충족 여부 실시간 판별.
    
- 이상 감지(취소율 2배/거래액 50% 이상 급감)를 즉시 트리거링하여 알림 서비스 연동(예: Slack, Webhook, SMS 등)으로 전송.
    
- 모든 집계 데이터와 거래 추이 시각화는 웹 대시보드로 확인 가능하도록 제공. 과거/실시간 데이터 분석 필요 시, OLAP성 분산 DB(예: Clickhouse/Druid) 연결도 추가.
    

## 요구사항 적용 방안

## 실시간 집계 및 리스크 탐지

- RDB에서 트랜잭션 로그 기반 이벤트를 CDC로 Kafka 스트림에 동기화.
    
- 1분 윈도우별 승인/취소 건수 및 거래액, 가맹점별 실시간 집계 처리.
    
- 취소율·거래액 데이터는 Redis/ScyllaDB 등 In-memory DB에 저장하며, 최근 N일간, 당일, 시간별 집계값 갱신.
    
- 취소율 2배, 거래액 50% 급감 조건은 집계 후 이벤트 기반 알림(이메일/Slack/SMS 등)으로 전송.
    

## 대시보드 및 트렌드 분석 화면

- 실시간 집계 데이터는 Grafana/Metabase와 연동된 대시보드에서 시각적으로 제공.
    
- 가맹점별 거래 추이, 취소율, 거래액 변동 그래프 및 이상 감지 이력 제공.
    

## 성능 및 확장성 고려

- 스트림 처리, 인메모리 캐시로 TPS 5,000 이상 실시간 집계 가능.
    
- 상위 1% 고거래 가맹점은 별도 레이어로 관리/우선 집계하여 알림 지연 최소화.
    
- 백엔드와 모니터링 시스템 분리, 장애·폭주 대응을 위한 수평확장 구조 설계.
    

## 참고 아키텍처 예시

- **CDC: Debezium, Maxwell 등으로 MySQL 등 RDB 트랜잭션 로그 스트림화**
    
- **Stream Processing: Apache Kafka + Apache Flink/Spark Streaming**
    
- **Cache & OLAP: Redis, ScyllaDB, Clickhouse**
    
- **Dashboard: Grafana, Metabase**
    
- **Alerting: Webhook, Slack, SMS, Push**
    

## 결론

이와 같이 CDC+Stream+Cache 구조를 활용하면 대량의 거래 데이터를 실시간으로 분석·집계하고, 리스크 이벤트를 즉시 탐지해 알림으로 연동할 수 있습니다. 거래 추이 대시보드까지 포함해서 요구되는 모든 기능을 고성능으로 구현할 수 있습니다.