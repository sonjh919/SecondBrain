#Architecture #DDD #Book

## Aggregate 루트
애그리거트는 여러 객체로 구성되기 때문에 한 객체만 상태가 정상이어서는 안된다. 도메인 규칙을 지키려면 애그리거트에 속한 모든 객체가 정상 상태를 가져야 한다.

> [!example]+ 
> 주문에서 구매할 상품의 개수를 변경하면 총 주문 금액도 변경해야 한다. 그렇지 않으면 다음 도메인 규칙을 어기고 데이트 일관성이 깨지게 된다.
> 
> + 주문 총 금액은 개별 상품의 주문 개수 x 가격의 합이다.

애그리거트에 속한 모든 객체가 일관된 상태를 유지하려면 애그리거트 전체를 관리할 주체가 필요한데 이 책임을 지는 것이 바로 애그리거트의 루트 엔티티이다.

> [!example]+ 
> + 주문 애그리거트의 루트는 Order이다.
> 
> ![[rootentity.png]]


## 도메인 규칙과 일관성
애그리거트 루트의 핵심 역할은 **애그리거트의 일관성이 깨지지 않도록 하는 것**이다. 이를 위해 애그리거트 루트는 애그리거트가 제공해야 할 **도메인 기능을 구현**한다. 애그리거트 루트가 제공하는 메서드는 도메인 규칙에 따라 애그리거트에 속한 **객체의 일관성이 깨지지 않도록 구현**해야 한다.

> [!example]+ 
> 주문 애그리거트는 배송지 변경, 상품 변경과 같은 기능을 제공하고, 애그리거트 루트인 Order가 이 기능을 구현한 메서드를 제공한다.


애그리거트 루트가 아닌 다른 객체가 애그리거트에 속한 객체를 직접 변경하면 안된다. 이는 애그리거트 루트가 강제하는 규칙을 적용할 수 없어 **모델의 일관성을 깨는 원인**이 된다.

> [!example]+ 
> ```java
> ShippingInfo si = order.getShippingInfo();
> si.setAddress(newAddress);
> ```

불필요한 중복을 피하고 애그리거트 루트를 통해서만 도메인 로직을 구현하게 만들려면 도메인 모델에 대해 다음의 두 가지를 습관적으로 적용해야 한다.

> [!important]+ 
> + 단순히 필드를 변경하는 set 메서드를 공개(public) 범위로 만들지 않는다.
> + 밸류 타입은 불변으로 구현한다.


> [!tip]+ 
> **결국 핵심은 또 돌고돌아 객체지향이다. 자기가 가지고 있는 필드에 대한 로직은 해당 클래스에서만 수행하자..!**


## 트랜잭션 범위
**트랜잭션 범위는 작을수록 좋다.**

> [!note]+ 
> 한 트랜잭션이 한 개 테이블을 수정하는 것과 세 개의 테이블을 수정하는 것을 비교하면 성능 차이가 발생한다. 한 개 테이블을 수정하면 트랜잭션 충돌을 막기 위해 잠그는 대상이 한 개 테이블의 한 행으로 한정되지만, 세 개의 테이블을 수정하면 잠금 대상이 더 많아진다는 의미다. 잠금 대상이 많아진다는 것은 그만큼 동시에 처리할 수 있는 트랜잭션 개수가 줄어든다는 것을 뜻하고 이는 전체적인 성능(처리량)을 떨어뜨린다.

동일하게 **한 트랜잭션에서는 한 개의 애그리거트만 수정**해야 한다. 한 트랜잭션에서 두 개 이상의 애그리거트를 수정하면 트랜잭션 충돌이 발생할 가능성이 더 높아지기 때문에 한번에 수정하는 애그리거트 개수가 많아질수록 전체 처리량이 떨어지게 된다.

만약 부득이하게 한 트랜잭션으로 두 개 이상의 애그리거트를 수정해야 한다면 응용 서비스에서 두 애그리거트를 수정하도록 구현해야 한다.

> [!tip]+ 
> 도메인 이벤트를 사용하면 한 트랜잭션에서 한 개의 애그리거트를 수정하면서도 동기나 비동기로 다른 애그리거트의 상태를 변경할 수 있다. (10장 참고)

한 트랜잭션에서 한 개의 애그리거트를 변경하는 것을 권장하지만 다음의 경우에는 두 개 이상의 애그리거트를 변경하는 것을 고려할 수 있다.

> [!summary]+ 
> + **팀 표준** : 조직의 표준에 따라 사용자 유스케이스와 관련된 응용 서비스의 기능을 한 트랜잭션으로 실행해야 하는 경우
> + **기술 제약** : 한 트랜잭션에서 두 개 이상의 애그리거트를 수정하는 대신 도메인 이벤트와 비동기를 사용하는 방식을 사용하는데, 기술적으로 이벤트 방식을 도입할 수 없는 경우 한 트랜잭션에서 다수의 애그리거트를 수정해서 일관성을 처리해야 한다.
> + **UI 구현의 편리** : 운영자의 편리함을 위해 주문 목록 화면에서 여러 주문의 상태를 한 번에 변경하고 싶을 경우

