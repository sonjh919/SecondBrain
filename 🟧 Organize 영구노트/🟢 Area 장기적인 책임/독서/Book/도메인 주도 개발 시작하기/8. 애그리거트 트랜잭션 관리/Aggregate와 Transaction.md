#Architecture #DDD #Book

## Aggregate와 Transaction
한 주문 애그리거트에 대해 운영자는 배송 준비 상태로 변경할 때 사용자는 배송지 주소를 변경하면 어떻게 될까?

![[aggregatetransaction.png]]

**트랜잭션마다 리포지터리는 새로운 애그리거트 객체를 생성**하므로 운영자 스레드와 고객 스레드는 **같은 주문 애그리거트를 나타내는 다른 객체를 구하게 된다.**

두 스레드는 각각 트랜잭션을 커밋할 때 수정한 내용을 DBMS에 반영한다. 즉, 배송 상태로 바뀌고 배송지 정보도 바뀌게 된다. 이 순서의 문제점은 운영자는 기존 배송지 정보를 이용해서 배송 상태로 변경했는데 그 사이 고객은 배송지 정보를 변경했다는 점이다. 즉, **애그리거트의 일관성이 깨지는 것**이다.

이런 문제가 발생하지 않게 하려면, 두 가지 중 하나를 해야 한다.

> [!summary]+ 
> 1. 운영자가 배송지 정보를 조회하고 상태를 변경하는 동안 고객이 애그리거트를 수정하지 못하게 막는다.
> 2. 운영자가 배송지 정보를 조회한 이후에 고객이 정보를 변경하면 운영자가 에그리거트를 다시 조회한 뒤 수정하도록 한다.

이 두 가지는 애그리거트 자체의 트랜잭션과 관련이 있다. DBMS가 지원하는 트랜잭션과 함께 애그리거트를 위한 추가적인 처리 기법이 필요하다. 대표적으로 두 가지 방식이 있다.

> [!summary]+ 
> 1. 선점 잠금 = Pessimistic Lock = 비관적 락
> 2. 비선점 잠금 = Optimistic Lock = 낙관적 락