#jpa 

## flush
```java
em.flush();
```

- 트랜잭션 commit 후 추가적인 동작이 있는데 바로 `em.flush();` 메서드의 호출이다.
- flush 메서드는 **영속성 컨텍스트의 변경 내용들을 DB에 동기화하는 역할**을 수행한다. 동기화를 최대한 늦출 수 있는 이유는 [[Project/JPA/트랜잭션/트랜잭션|트랜잭션]]이라는 작업 단위가 있기 때문이다.
+ 즉, **[[쓰기 지연 저장소]]의 SQL들을 DB에 요청하는 역할**을 수행한다.

이 기능을 잘 활용하면 모아둔 등록 쿼리를 DB에 한번에 전달하여 성능을 최적화할 수 있다.

### flush 실행 과정
1. [[변경 감지]]가 작동해서 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교하여 수정된 엔티티를 찾는다.
2. 수정된 엔티티는 수정 쿼리를 만들어 쓰기 지연 SQL 저장소에 등록한다.
3. 쓰기 지연 SQL 저장소의 쿼리를 DB에 전송한다.(CRUD)

### 영속성 컨텍스트를 flush하는 방법
1. em.flush()를 직접 호출한다.
2. 트랜잭션 commit 시 flush가 자동 호출된다.
3. JPQL 쿼리 실행 시 flush가 자동 호출된다.

> [!tip]+ 
> 영속성 컨텍스트에 있는 변경사항을 적용시키기 위해서 JPQL 쿼리 실행 전 flush가 실행된다.


### flush 모드 옵션
EntityManager에 플러시 모드를 직접 지정하려면 FlushModeType을 사용할 수 있다. 대부분 AUTO 기본 설정을 그대로 사용하지만, COMMIT 모드는 성능 최적화를 위해 사용할 수 있다.

> [!note]+ 
> + FlushModeType.AUTO : 커밋이나 쿼리를 실행할 때 flush(기본값)
> + FlushModeType.COMMIT : 커밋할 때만 플러시